<template>
    <div class="home">
        <svg xmlns="http://www.w3.org/2000/svg"
             width="120pt" height="120pt" viewBox="-400 -400 800 800"
             preserveAspectRatio="xMidYMid meet">
            <path id="ff-gear-1"
                  d="M 115.3243179321289 72.06262969970703 l -3.29 4.94l -3.60 4.71l -4.19 4.22l -5.78 2.73l -9.40 -1.13l -11.93 -4.81l -8.63 -2.51l -5.17 0.86l -3.99 2.13l -3.78 2.37l -3.81 2.31l -3.88 2.17l -3.96 2.04l -4.00 1.98l -3.90 2.29l -3.43 3.95l -2.37 8.67l -2.14 12.68l -3.95 8.60l -5.34 3.50l -5.79 1.37l -5.90 0.60l -5.93 0.22l -5.93 -0.08l -5.92 -0.38l -5.88 -0.76l -5.75 -1.52l -5.25 -3.64l -3.72 -8.70l -1.80 -12.73l -2.14 -8.73l -3.33 -4.04l -3.84 -2.39l -3.94 -2.08l -3.90 -2.14l -3.83 -2.28l -3.74 -2.41l -3.71 -2.47l -3.93 -2.24l -5.14 -1.00l -8.69 2.28l -12.05 4.49l -9.42 0.88l -5.71 -2.88l -4.08 -4.33l -3.47 -4.81l -3.15 -5.02l -2.90 -5.18l -2.64 -5.31l -2.28 -5.47l -1.56 -5.74l 0.53 -6.37l 5.68 -7.57l 10.13 -7.93l 6.49 -6.22l 1.84 -4.90l 0.15 -4.52l -0.17 -4.46l -0.10 -4.45l 0.06 -4.45l 0.21 -4.45l 0.28 -4.45l -0.03 -4.53l -1.71 -4.95l -6.32 -6.39l -9.92 -8.19l -5.48 -7.72l -0.36 -6.38l 1.71 -5.70l 2.43 -5.41l 2.77 -5.24l 3.03 -5.10l 3.29 -4.94l 3.60 -4.71l 4.19 -4.22l 5.78 -2.73l 9.40 1.13l 11.93 4.81l 8.63 2.51l 5.17 -0.86l 3.99 -2.13l 3.78 -2.37l 3.81 -2.31l 3.88 -2.17l 3.96 -2.04l 4.00 -1.98l 3.90 -2.29l 3.43 -3.95l 2.37 -8.67l 2.14 -12.68l 3.95 -8.60l 5.34 -3.50l 5.79 -1.37l 5.90 -0.60l 5.93 -0.22l 5.93 0.08l 5.92 0.38l 5.88 0.76l 5.75 1.52l 5.25 3.64l 3.72 8.70l 1.80 12.73l 2.14 8.73l 3.33 4.04l 3.84 2.39l 3.94 2.08l 3.90 2.14l 3.83 2.28l 3.74 2.41l 3.71 2.47l 3.93 2.24l 5.14 1.00l 8.69 -2.28l 12.05 -4.49l 9.42 -0.88l 5.71 2.88l 4.08 4.33l 3.47 4.81l 3.15 5.02l 2.90 5.18l 2.64 5.31l 2.28 5.47l 1.56 5.74l -0.53 6.37l -5.68 7.57l -10.13 7.93l -6.49 6.22l -1.84 4.90l -0.15 4.52l 0.17 4.46l 0.10 4.45l -0.06 4.45l -0.21 4.45l -0.28 4.45l 0.03 4.53l 1.71 4.95l 6.32 6.39l 9.92 8.19l 5.48 7.72l 0.36 6.38l -1.71 5.70l -2.43 5.41l -2.77 5.24 z"/>
            <circle id="ff-centre-1" r="36"></circle>
            <path id="ff-gear-2"
                  d="M 203.99978637695312 0.0 l -0.07 5.34l -0.22 5.34l -0.48 5.32l -1.59 5.20l -7.88 4.32l -17.38 2.43l -7.99 3.27l -1.96 4.17l -1.11 4.31l -1.11 4.31l -1.21 4.28l -1.32 4.25l -1.43 4.21l -1.53 4.18l -1.53 4.18l -0.75 4.54l 4.73 7.22l 12.94 11.84l 4.05 8.02l -1.63 5.19l -2.62 4.65l -2.84 4.52l -2.97 4.44l -3.08 4.36l -3.20 4.28l -3.32 4.18l -3.51 4.02l -4.34 3.27l -8.91 -1.14l -15.48 -8.25l -8.39 -2.05l -4.03 2.22l -3.43 2.84l -3.43 2.83l -3.50 2.75l -3.57 2.66l -3.63 2.57l -3.69 2.49l -3.70 2.49l -3.27 3.24l -0.42 8.62l 3.51 17.19l -1.44 8.87l -4.37 3.24l -4.85 2.23l -4.95 1.99l -5.01 1.85l -5.06 1.72l -5.10 1.58l -5.14 1.44l -5.21 1.19l -5.44 0.09l -6.54 -6.16l -7.68 -15.77l -5.58 -6.59l -4.57 -0.58l -4.45 0.28l -4.44 0.28l -4.45 0.17l -4.45 0.06l -4.45 -0.06l -4.45 -0.16l -4.45 -0.16l -4.55 0.70l -5.41 6.73l -7.26 15.97l -6.38 6.33l -5.44 0.05l -5.24 -1.05l -5.18 -1.30l -5.14 -1.45l -5.10 -1.58l -5.06 -1.72l -5.01 -1.86l -4.91 -2.10l -4.45 -3.12l -1.67 -8.83l 3.06 -17.27l -0.64 -8.61l -3.36 -3.15l -3.76 -2.39l -3.76 -2.39l -3.70 -2.47l -3.63 -2.57l -3.57 -2.66l -3.50 -2.74l -3.51 -2.75l -4.09 -2.11l -8.33 2.27l -15.26 8.65l -8.88 1.37l -4.43 -3.16l -3.62 -3.93l -3.43 -4.10l -3.31 -4.19l -3.20 -4.28l -3.08 -4.36l -2.95 -4.45l -2.74 -4.58l -1.77 -5.14l 3.84 -8.12l 12.63 -12.18l 4.54 -7.34l -0.86 -4.52l -1.64 -4.14l -1.64 -4.14l -1.54 -4.18l -1.43 -4.21l -1.32 -4.25l -1.22 -4.28l -1.22 -4.28l -2.07 -4.11l -8.07 -3.06l -17.43 -1.97l -7.99 -4.11l -1.73 -5.15l -0.62 -5.30l -0.36 -5.33l -0.21 -5.34l -0.07 -5.34l 0.07 -5.34l 0.22 -5.34l 0.48 -5.32l 1.59 -5.20l 7.88 -4.32l 17.38 -2.43l 7.99 -3.27l 1.96 -4.17l 1.11 -4.31l 1.11 -4.31l 1.21 -4.28l 1.32 -4.25l 1.43 -4.21l 1.53 -4.18l 1.53 -4.18l 0.75 -4.54l -4.73 -7.22l -12.94 -11.84l -4.05 -8.02l 1.63 -5.19l 2.62 -4.65l 2.84 -4.52l 2.97 -4.44l 3.08 -4.36l 3.20 -4.28l 3.32 -4.18l 3.51 -4.02l 4.34 -3.27l 8.91 1.14l 15.48 8.25l 8.39 2.05l 4.03 -2.22l 3.43 -2.84l 3.43 -2.83l 3.50 -2.75l 3.57 -2.66l 3.63 -2.57l 3.69 -2.49l 3.70 -2.49l 3.27 -3.24l 0.42 -8.62l -3.51 -17.19l 1.44 -8.87l 4.37 -3.24l 4.85 -2.23l 4.95 -1.99l 5.01 -1.85l 5.06 -1.72l 5.10 -1.58l 5.14 -1.44l 5.21 -1.19l 5.44 -0.09l 6.54 6.16l 7.68 15.77l 5.58 6.59l 4.57 0.58l 4.45 -0.28l 4.44 -0.28l 4.45 -0.17l 4.45 -0.06l 4.45 0.06l 4.45 0.16l 4.45 0.16l 4.55 -0.70l 5.41 -6.73l 7.26 -15.97l 6.38 -6.33l 5.44 -0.05l 5.24 1.05l 5.18 1.30l 5.14 1.45l 5.10 1.58l 5.06 1.72l 5.01 1.86l 4.91 2.10l 4.45 3.12l 1.67 8.83l -3.06 17.27l 0.64 8.61l 3.36 3.15l 3.76 2.39l 3.76 2.39l 3.70 2.47l 3.63 2.57l 3.57 2.66l 3.50 2.74l 3.51 2.75l 4.09 2.11l 8.33 -2.27l 15.26 -8.65l 8.88 -1.37l 4.43 3.16l 3.62 3.93l 3.43 4.10l 3.31 4.19l 3.20 4.28l 3.08 4.36l 2.95 4.45l 2.74 4.58l 1.77 5.14l -3.84 8.12l -12.63 12.18l -4.54 7.34l 0.86 4.52l 1.64 4.14l 1.64 4.14l 1.54 4.18l 1.43 4.21l 1.32 4.25l 1.22 4.28l 1.22 4.28l 2.07 4.11l 8.07 3.06l 17.43 1.97l 7.99 4.11l 1.73 5.15l 0.62 5.30l 0.36 5.33l 0.21 5.34 z"/>
            <circle id="ff-centre-2" r="36"></circle>
            <path id="ff-gear-3"
                  d="M 139.25457763671875 97.50711059570312 l -3.27 4.50l -3.45 4.36l -3.78 4.09l -4.96 2.98l -9.27 -1.38l -13.73 -6.77l -8.62 -2.47l -4.53 1.64l -3.65 2.58l -3.58 2.65l -3.64 2.57l -3.71 2.45l -3.79 2.34l -3.84 2.25l -3.80 2.34l -3.28 3.52l -1.11 8.90l 0.83 15.29l -2.37 9.06l -4.69 3.39l -5.24 1.87l -5.37 1.46l -5.42 1.24l -5.46 1.06l -5.49 0.87l -5.52 0.65l -5.56 0.22l -5.62 -1.40l -5.58 -7.53l -4.93 -14.50l -4.35 -7.85l -4.36 -2.04l -4.40 -0.76l -4.40 -0.65l -4.39 -0.76l -4.36 -0.89l -4.33 -1.03l -4.31 -1.13l -4.35 -1.03l -4.81 0.17l -7.08 5.51l -10.23 11.40l -8.08 4.73l -5.71 -0.92l -5.03 -2.38l -4.83 -2.76l -4.71 -2.96l -4.61 -3.12l -4.50 -3.27l -4.36 -3.45l -4.09 -3.78l -2.98 -4.96l 1.38 -9.27l 6.77 -13.73l 2.47 -8.62l -1.64 -4.53l -2.58 -3.65l -2.65 -3.58l -2.57 -3.64l -2.45 -3.71l -2.34 -3.79l -2.25 -3.84l -2.34 -3.80l -3.52 -3.28l -8.90 -1.11l -15.29 0.83l -9.06 -2.37l -3.39 -4.69l -1.87 -5.24l -1.46 -5.37l -1.24 -5.42l -1.06 -5.46l -0.87 -5.49l -0.65 -5.52l -0.22 -5.56l 1.40 -5.62l 7.53 -5.58l 14.50 -4.93l 7.85 -4.35l 2.04 -4.36l 0.76 -4.40l 0.65 -4.40l 0.76 -4.39l 0.89 -4.36l 1.03 -4.33l 1.13 -4.31l 1.03 -4.35l -0.17 -4.81l -5.51 -7.08l -11.40 -10.23l -4.73 -8.08l 0.92 -5.71l 2.38 -5.03l 2.76 -4.83l 2.96 -4.71l 3.12 -4.61l 3.27 -4.50l 3.45 -4.36l 3.78 -4.09l 4.96 -2.98l 9.27 1.38l 13.73 6.77l 8.62 2.47l 4.53 -1.64l 3.65 -2.58l 3.58 -2.65l 3.64 -2.57l 3.71 -2.45l 3.79 -2.34l 3.84 -2.25l 3.80 -2.34l 3.28 -3.52l 1.11 -8.90l -0.83 -15.29l 2.37 -9.06l 4.69 -3.39l 5.24 -1.87l 5.37 -1.46l 5.42 -1.24l 5.46 -1.06l 5.49 -0.87l 5.52 -0.65l 5.56 -0.22l 5.62 1.40l 5.58 7.53l 4.93 14.50l 4.35 7.85l 4.36 2.04l 4.40 0.76l 4.40 0.65l 4.39 0.76l 4.36 0.89l 4.33 1.03l 4.31 1.13l 4.35 1.03l 4.81 -0.17l 7.08 -5.51l 10.23 -11.40l 8.08 -4.73l 5.71 0.92l 5.03 2.38l 4.83 2.76l 4.71 2.96l 4.61 3.12l 4.50 3.27l 4.36 3.45l 4.09 3.78l 2.98 4.96l -1.38 9.27l -6.77 13.73l -2.47 8.62l 1.64 4.53l 2.58 3.65l 2.65 3.58l 2.57 3.64l 2.45 3.71l 2.34 3.79l 2.25 3.84l 2.34 3.80l 3.52 3.28l 8.90 1.11l 15.29 -0.83l 9.06 2.37l 3.39 4.69l 1.87 5.24l 1.46 5.37l 1.24 5.42l 1.06 5.46l 0.87 5.49l 0.65 5.52l 0.22 5.56l -1.40 5.62l -7.53 5.58l -14.50 4.93l -7.85 4.35l -2.04 4.36l -0.76 4.40l -0.65 4.40l -0.76 4.39l -0.89 4.36l -1.03 4.33l -1.13 4.31l -1.03 4.35l 0.17 4.81l 5.51 7.08l 11.40 10.23l 4.73 8.08l -0.92 5.71l -2.38 5.03l -2.76 4.83l -2.96 4.71 z"/>
            <circle id="ff-centre-3" r="36"></circle>
        </svg>

        <!--suppress CssInvalidFunction, CssInvalidPropertyValue -->
        <HelloWorld msg="Welcome to Your Vue.js App"/>

        <button v-on:click="startRecording">Start Recording</button>
        <button v-on:click="stopRecording">Stop Recording</button>
        <button v-on:click="demo">Demo from .WAV file</button>
        <span class="block">Performance: {{ this.$data.postProcPerf }} ms</span>
        <ul id="results">
            <li v-for="item in this.$data.tunesTable" v-bind:key="item.setting">
                {{ item.name }}
            </li>
        </ul>
    </div>
</template>

<script>
import HelloWorld from "@/components/HelloWorld.vue";

import audioService from "@/folkfriend/ff-audio";
import transcriber from "@/folkfriend/ff-transcriber.worker";
import queryEngine from "@/folkfriend/ff-query-engine";
import ds from "../services/database.worker";

export default {
    name: 'Home',
    components: {
        HelloWorld
    },
    mounted: function () {
        console.debug('Home loaded');
    },
    data() {
        return {
            tunesTable: [],
            postProcPerf: 0
        };
    },
    methods: {
        demo: async function () {
            const t0 = Date.now();

            const timeDomainDataQueue = await audioService.urlToTimeDomainData('audio/fiddle.wav');
            const decoded = await transcriber.transcribeTimeDomainData(timeDomainDataQueue);
            console.debug(decoded);

            if (!decoded) {
                console.warn('No music decoded');
                return;
            }

            const result = await queryEngine.query(decoded.midis);
            console.debug(result);

            let tunes = await ds.tunesFromQueryResults(result);
            console.debug(tunes);


            this.$data.postProcPerf = Math.round(Date.now() - t0);
            this.$data.tunesTable = tunes.slice(0, 10);
        },

        startRecording: async function () {
            await audioService.startRecording();
        },
        stopRecording: async function () {
            const t0 = Date.now();

            console.debug('Audio stopping');
            await audioService.stopRecording();
            console.debug('Audio stopped');

            const decoded = await transcriber.gatherAndDecode();
            console.debug(decoded);

            if (!decoded) {
                console.warn('No music decoded');
                return;
            }

            const result = await queryEngine.query(decoded.midis);
            console.debug(result);

            let tunes = await ds.tunesFromQueryResults(result);
            console.debug(tunes);

            this.$data.postProcPerf = Math.round(Date.now() - t0);
            this.$data.tunesTable = tunes.slice(0, 10);
        },

        renderImageForDebug: function (typedArrays) {
            console.debug(typedArrays);

            const w = typedArrays.length;
            const h = typedArrays[0].length;
            const scale = 1;

            const canvas = document.createElement('canvas');
            canvas.setAttribute("style", "zoom: 2; image-rendering: pixelated;");
            canvas.width = scale * w;
            canvas.height = scale * h;

            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            const imageData = ctx.createImageData(w, h);

            const max = Math.max(...typedArrays.map(x => Math.max(...x)).filter(x => isFinite(x)));
            const min = Math.min(...typedArrays.map(x => Math.min(...x)).filter(x => isFinite(x)));
            const range = max - min;

            // Iterate through every pixel
            for (let x = 0; x < w; x++) {
                for (let y = 0; y < h; y++) {
                    const i = 4 * (y * w + x);
                    const v = Math.round(255 * (typedArrays[x][y] - min) / range);
                    imageData.data[i] = v;          // R value
                    imageData.data[i + 1] = v;      // G value
                    imageData.data[i + 2] = v;      // B value
                    imageData.data[i + 3] = 255;    // A value
                }
            }

            // Draw image data to the canvas
            ctx.putImageData(imageData, 0, 0);

            document.body.appendChild(canvas);
        }
    }
};


</script>

<style scoped>

.block {
    display: block;
}

/* Smallest */
#ff-gear-1 {
    animation: spin1 6s infinite linear reverse;
    transform-origin: 87px -257px;
}

#ff-centre-1 {
    transform: translate(87px, -257px);
}

/* Largest */
#ff-gear-2 {
    animation: spin2 10s infinite linear;
    transform-origin: -136px -34px;
}

#ff-centre-2 {
    transform: translate(-136px, -34px);
}

/* Medium */
#ff-gear-3 {
    animation: spin3 8s infinite linear reverse;
    transform-origin: 111px 213px;
}

#ff-centre-3 {
    transform: translate(111px, 213px);
}

#ff-gear-1, #ff-gear-2, #ff-gear-3, circle {
    fill: none;
    stroke: black;
    stroke-width: 10px;
    stroke-linejoin: round;
    will-change: transform;
}

@keyframes spin1 {
    from {
        transform: rotate(0deg) translate(87px, -257px);
    }
    to {
        transform: rotate(360deg) translate(87px, -257px);
    }
}

@keyframes spin2 {
    from {
        transform: rotate(0deg) translate(-136px, -34px);
    }
    to {
        transform: rotate(360deg) translate(-136px, -34px);
    }
}

@keyframes spin3 {
    from {
        transform: rotate(0deg) translate(111px, 213px);
    }
    to {
        transform: rotate(360deg) translate(111px, 213px);
    }
}

</style>
